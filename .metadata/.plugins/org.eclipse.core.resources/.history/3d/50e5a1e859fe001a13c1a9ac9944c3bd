package com.jeeihyun.server.net;

import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.IOException;
import java.net.Socket;

import com.secho.server.handle.DataHandle;

/**
 * 서버에서 대기중에 Socket을 통해 클라이언트 요청이 온후 처리할 프로세스 정의 
 * @author seCho
 *
 */
class ReceiveThread extends Thread implements Runnable{
    //private Socket Socket;
    DataInputStream input;
    DataOutputStream output;
    DataHandle dHandle = null;
    
    
    public ReceiveThread(Socket Socket) {
     //this.Socket = Socket;
        try {
                input = new DataInputStream(Socket.getInputStream());  //클라이언트로 부터 입력되는 데이타를 받아내는곳
                output = new DataOutputStream(Socket.getOutputStream()); //서버(나)에서 클라이언트로 데이타를 출력(보내는)해주는 곳.                                                      
                
                dHandle = new DataHandle();          
                dHandle.init();                    
                    
        } catch (IOException e) {
                e.printStackTrace();
        }
    }
    
    
    int schLastPos = 33;
    
    public synchronized void run() {
    	
            while (input != null) {
                try {
                    String msg = input.readUTF();
                    if ((msg.charAt(0)) == '%') {
                        dHandle.setTset(msg);
                    } else if ((msg.charAt(0)) == '$') {
                        System.out.println("Tset 수신");
                        System.out.println("* client 명령 대기   *");

                    } else if ((msg.charAt(0)) == '※') {
                        System.out.println("keyword를 클라이언트로부터 받음");
                        String  strFileList = dHandle.Sendlist(msg.substring(1,schLastPos));
                        
                        if(strFileList == null || strFileList.length()==0) {
                        	strFileList = "검색에 해당되는 파일을 찾을 수 없음";
                        }
                        Thread.sleep(500);                        
                        output.writeUTF(strFileList);
                        
                       // output.write(strFileList.getBytes());
                        output.flush();
                        
                        System.out.println("파일 전송.");
                        System.out.println("* Client 명령 대기 중  *");
                    }                   
                                        
                } catch (IOException e) {
                    System.out.println("Client 종료.");
                    break;
                } catch (InterruptedException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
            }
    }
}